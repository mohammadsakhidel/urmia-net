add_css('_PostEditor');
add_js('_PostEditor');
//load:
$(function () {
    _PostEditorLoad();
});
function _PostEditorLoad() {
    //********** attached file upload related:
    $('#post_editor a.add_photo, #post_editor a.add_video').live('click', function () {
        select_attachment($(this));
    });
    $('div#post_editor input#posted_file').live('change', function () {
        if ($.trim($(this).val()).length > 0) {
            $('form#frm_add_attachment').submit();
        }
    });
    $('#post_editor #uploaded_files a.added_photo_remove').live('click', function () {
        var id_to_remove = $(this).parent().attr('id');
        remove_attached_file(id_to_remove);
    });
    //********** tag remove:
    $('#post_added_tags .tag').live('click', function () {
        var tag = $(this).find('span').text();
        remove_tag(tag);
    });
    //********** plugins:
    plugin_autosize($('#post_txt'));
    plugin_watermark($('#post_txt'), $('input#w_what_in_mind').val());
    plugin_watermark($('#post_tags'), $('input#w_tags').val());
    var url_of_tag_sugg = $('#post_tags').next('input[type="hidden"]').val();
    plugin_autocomplete($('#post_tags'), url_of_tag_sugg);
    /* ************************ Upload Post Photos ************************ */
    var bar = $('#post_editor .bar');
    var percent = $('#post_editor .percent');
    setTimeout(function () {

        $('#frm_add_attachment').ajaxForm({
            dataType: 'json',
            type: 'POST',
            contentType: 'application/json',
            beforeSend: function () {
                $('#post_editor #post_message').hide();
                var percentVal = '0%';
                bar.width(percentVal)
                percent.html(percentVal);
                $('#post_editor #upload_progress').fadeIn('fast');
            },
            uploadProgress: function (event, position, total, percentComplete) {
                var percentVal = percentComplete + '%';
                bar.width(percentVal)
                percent.html(percentVal);
            },
            success: function () {
                var percentVal = '100%';
                bar.width(percentVal)
                percent.html(percentVal);
            },
            complete: function (xhr) {
                var d = $.parseJSON(xhr.responseText);
                if (d.Done) {
                    add_attached_file(d.TempFileName, d.Path);
                }
                else {
                    $('#post_editor #post_message')
                        .removeClass('success_message')
                        .addClass('error_message')
                        .html(d.Errors[0]).fadeIn('fast');
                }
                setTimeout(function () {
                    hide_progress();
                }, 2000);
            }
        });

    }, 500);
}

function hide_progress() {
    $('#post_editor #upload_progress').fadeOut('fast');
}

function add_attached_file(fileName, thumbPath) {
    // add to temp file names:
    var added_temp_files = $('input[name="TempFileNames"]').eq(0).val();
    $('input[name="TempFileNames"]').val(added_temp_files + fileName + ';');
    // add to thumbnails:
    var id = conv_filname_to_id(fileName);
    var html =
        '<div id="' + id + '" class="added_photo_parent">' +
            '<img class="thumb" src="' + thumbPath + '" />' +
            '<a class="added_photo_remove"></a>' +
        '</div>';
    $('#post_editor #uploaded_files').append(html);
}

function remove_attached_file(id) {
    var filename = conv_id_to_filename(id);
    // remove from temp file names:
    var added_temp_files = $('input[name="TempFileNames"]').eq(0).val();
    added_temp_files = added_temp_files.replace(filename + ';', '');
    $('input[name="TempFileNames"]').val(added_temp_files);
    // remove from thumbs:
    $('#post_editor #uploaded_files #' + id).remove();
}

function conv_filname_to_id(txt) {
    return txt.replace('.', '_');
}

function conv_id_to_filename(txt) {
    return txt.replace('_', '.');
}

function get_attached_file_names() {
    var names = $('input[name="TempFileNames"]').eq(0).val();
    var filtered = new Array();
    filtered = split(names, ';');
    return filtered;
}

function any_none_video_attached() {
    var res = false;
    var att_files = get_attached_file_names();
    var supp_formats = split($('input#hid_sup_ph_formats').val(), ',');
    for (var i = 0; i < att_files.length; i++) {
        for (var j = 0; j < supp_formats.length; j++) {
            if (att_files[i].match(supp_formats[j] + "$")) {
                res = true;
            }
        }
    }
    return res;
}

function any_none_photo_attached() {
    var res = false;
    var att_files = get_attached_file_names();
    var supp_formats = split($('input#hid_sup_vid_formats').val(), ',');
    for (var i = 0; i < att_files.length; i++) {
        for (var j = 0; j < supp_formats.length; j++) {
            if (att_files[i].match(supp_formats[j] + "$")) {
                res = true;
            }
        }
    }
    return res;
}

var tempAttachmentType = '';
function select_attachment(sender) {
    var attachmentType = sender.hasClass('add_photo') ? "photo" : (sender.hasClass('add_video') ? "video" : "");
    tempAttachmentType = attachmentType;
    if (attachmentType == 'video' && any_none_video_attached()) {
        show_confirm_dialog($('#w_notice').val(), $('#w_post_editor_warning_for_filetypes').val(), 'clear_attacheds_and_show_open_dialog');
    }
    else if (attachmentType == 'photo' && any_none_photo_attached()) {
        show_confirm_dialog($('#w_notice').val(), $('#w_post_editor_warning_for_filetypes').val(), 'clear_attacheds_and_show_open_dialog');
    }
    else {
        $('#post_editor input[name="AttachmentsType"]').val(tempAttachmentType);
        show_open_dialog();
    }
}

function clear_attacheds_and_show_open_dialog() {
    var attached_files = get_attached_file_names();
    for (var i = 0; i < attached_files.length; i++) {
        var attached_file_id = conv_filname_to_id(attached_files[i]);
        remove_attached_file(attached_file_id);
    }
    $('#post_editor input[name="AttachmentsType"]').val(tempAttachmentType);
    show_open_dialog();
}

function show_open_dialog() {
    document.getElementById('posted_file').click();
}