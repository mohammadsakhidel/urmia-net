function connectToFb() {
    
    FB.login(function (loginResponse) {
        if (loginResponse.status === 'connected') {
            $('#prgFbConnect').show();
            $('#msgFbConnect').hide();
            FB.api('/me', function (apiResponse) {
                var connectionInfo = {
                    userId: loginResponse.authResponse.userID,
                    firstName: apiResponse.first_name,
                    lastName: apiResponse.last_name,
                    email: apiResponse.email,
                    birthday: apiResponse.birthday,
                    gender: apiResponse.gender
                };
                submitConnectionInfo(connectionInfo);
            });
        }
        else {
            show_error($('input#hid_fb_connect_error').val());
        }

    }, { scope: 'email, user_birthday' });
}

function submitConnectionInfo(connectionInfo) {
    $.ajax({
        url: "/account/facebookconnect",
        type: "POST",
        data: connectionInfo,
        error: function () {
            $('#prgFbConnect').hide();
            show_error($('input#hid_fb_connect_error').val());
        },
        success: function (data) {
            $('#prgFbConnect').hide();
            if (data.Done) {
                show_success(data.Message);
            }
            else {
                var errorMsg = "<ul>";
                for (var i = 0; i < data.Errors.length; i++) {
                    errorMsg += "<li>" + data.Errors[i] + "</li>";
                }
                errorMsg += "</ul>";
                show_error(errorMsg);
            }
        }
    });
}

function show_error(msg) {
    $('#msgFbConnect').html(msg).removeClass('success_message').addClass('error_message').show();
}

function show_success(msg) {
    $('#msgFbConnect').html(msg).removeClass('error_message').addClass('success_message').show();
}